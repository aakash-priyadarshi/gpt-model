<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Chat Application</title>
</head>
<body>
  <div class="col-md-6">
    <div class="page-header TopLeftHeader">GPT Model</div>
    <ul id="messages" class="overflow-auto chatbox bg-light bg-gradient" style="box-sizing: border-box;"></ul>
    <form id="chat-form">
      <div class="d-flex input-group">
        <input type="file" id="file-input" hidden />
        <label for="file-input" class="btn btn-outline-primary">
          <i class="fa fa-paperclip"></i>
        </label>
        <input id="m" autocomplete="off" class="form-control" placeholder="Type a message..." />
        <button id="button" class="btn btn-primary" type="submit">Send</button>
      </div>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://kit.fontawesome.com/4ed26f18fb.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    $(function () {
      var socket = io();
      $('#chat-form').submit(function (e) {
  e.preventDefault();
  var fileInput = $('#file-input')[0];
  if (fileInput.files.length > 0) {
    // Handle file upload
    var formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('socketId', socket.id); // Include the socket ID
    uploadFile(formData);
  } else {
    // Send text message
    var message = $('#m').val().trim();
    sendMessage(message);
  }
});

function uploadFile(formData) {
  // Show a loading message or spinner
  $("#button").html("Uploading...").prop('disabled', true);
  $('#messages').append($('<div class="chat_message user_output" id="uploading"><li>Uploading file...</li></div>'));
  scrollToBottom();

  $.ajax({
    url: '/upload',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(response) {
      // Remove the uploading message
      $('#uploading').remove();
      
      // If the server responds with the extracted text
      if (response && response.text) {
        // Show a confirmation message to the user
        $('#messages').append($('<div class="chat_message user_output"><li>File uploaded successfully!</li></div>'));
        scrollToBottom();
        sendMessage(response.text); // Send the extracted text as a message
      } else {
        // If the response doesn't have text, something went wrong server-side
        $('#messages').append($('<div class="chat_message user_output"><li>File uploaded but no text was extracted.</li></div>'));
        scrollToBottom();
      }
      
      $("#button").html("Send").prop('disabled', false);
      $('#file-input').val(''); // Clear the file input
    },
    error: function(jqXHR, textStatus, errorThrown) {
      // Remove the uploading message
      $('#uploading').remove();
      
      // Show an error message
      $('#messages').append($('<div class="chat_message user_output"><li>File upload failed: ' + errorThrown + '</li></div>'));
      scrollToBottom();
      
      $("#button").html("Send").prop('disabled', false);
      console.error('File upload failed:', textStatus, errorThrown);
      alert('File upload failed.');
    }
  });
}

function sendMessage(message) {
  if (message) {
    $("#button").html("Loading...").prop('disabled', true);
    $('#messages').append($('<div class="chat_message user_output"><li>' + message + '</li></div>'));
    scrollToBottom();
    socket.emit('chat message', message);
    $('#m').val('');
  }
}

      socket.on('chat message', function (msg) {
        if (msg) {
          $('#messages').append($('<div class="chat_message chatbot_output"><li>' + msg + 
          '<span class="thumbs-icons">' +
          '<i onclick="likeFunction(this)" class="fa fa-thumbs-up"></i>' +
          '<i onclick="dislikeFunction(this)" class="fa fa-thumbs-down"></i>' +
          '</span></li></div>'));
        } else {
          $('#messages').append($('<div class="chat_message chatbot_output"><li>Error: The server response is empty.</li></div>'));
        }
        $("#button").html("Send").prop('disabled', false);
        scrollToBottom();
      });

      function scrollToBottom() {
        $('#messages').scrollTop($('#messages')[0].scrollHeight);
      }

      socket.on('disconnect', function () {
        $("#button").html("Send").prop('disabled', false);
        $('#messages').append($('<div class="chat_message chatbot_output"><li>Error: Connection to server lost. Please refresh the page.</li></div>'));
      });
    });

    function likeFunction(button) {
      $(button).toggleClass('liked');
    }

    function dislikeFunction(button) {
      $(button).toggleClass('disliked');
    }
    
    function Create_Chart() {
      $('#messages').append($('<div class="chat_message chatbot_output"><li><canvas id="chart"></canvas></li></div>'));
      const ctx = document.getElementById('chart');
      new Chart(
        ctx, {
          type: 'bar', //can change to pie for a pie chart
          data: {
            labels: ['one', 'two', 'three', 'four', 'five', 'six'],
            datasets: 
            [
              {
                label: 'FirstData',
                data: [12, 19, 3, 5, 2, 3],
                borderWidth: 1
              },
              {
                label: 'SecondData',
                data: [1,2,3,4,5,6],
                borderWidth: 1
              }
            ]
          },
          options: {
            scales: {
              x: {
                stacked: true 
              },
              y: {
                beginAtZero: true,
                stacked: true
              }
            }
          }
        }
      );
    };
  </script>
</body>
</html>
